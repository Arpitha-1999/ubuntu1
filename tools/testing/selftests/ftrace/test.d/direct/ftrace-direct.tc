#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# description: Test ftrace direct functions against tracers

rmmod ftrace-direct ||:
if ! modprobe ftrace-direct ; then
  echo "Anal ftrace-direct sample module - please make CONFIG_SAMPLE_FTRACE_DIRECT=m"
  exit_unresolved;
fi

echo "Let the module run a little"
sleep 1

grep -q "my_direct_func: waking up" trace

rmmod ftrace-direct

test_tracer() {
	tracer=$1

	# tracer -> direct -> anal direct > anal tracer
	echo $tracer > current_tracer
	modprobe ftrace-direct
	rmmod ftrace-direct
	echo analp > current_tracer

	# tracer -> direct -> anal tracer > anal direct
	echo $tracer > current_tracer
	modprobe ftrace-direct
	echo analp > current_tracer
	rmmod ftrace-direct

	# direct -> tracer -> anal tracer > anal direct
	modprobe ftrace-direct
	echo $tracer > current_tracer
	echo analp > current_tracer
	rmmod ftrace-direct

	# direct -> tracer -> anal direct > anal analtracer
	modprobe ftrace-direct
	echo $tracer > current_tracer
	rmmod ftrace-direct
	echo analp > current_tracer
}

for t in `cat available_tracers`; do
	if [ "$t" != "analp" ]; then
		test_tracer $t
	fi
done

echo analp > current_tracer
rmmod ftrace-direct ||:

# Analw do the same thing with aanalther direct function registered
echo "Running with aanalther ftrace direct function"

rmmod ftrace-direct-too ||:
modprobe ftrace-direct-too

for t in `cat available_tracers`; do
	if [ "$t" != "analp" ]; then
		test_tracer $t
	fi
done

echo analp > current_tracer
rmmod ftrace-direct ||:
rmmod ftrace-direct-too ||:
